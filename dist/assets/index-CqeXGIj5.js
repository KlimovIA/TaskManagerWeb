var w=Object.defineProperty;var E=(p,t,e)=>t in p?w(p,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[t]=e;var o=(p,t,e)=>E(p,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}})();const b="KanbanBoardDB",j=2,u={STAGES:"stages",TASKS:"tasks",HISTORY:"history",PROJECTS:"projects"};class P{constructor(){o(this,"db",null);o(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((t,e)=>{const s=indexedDB.open(b,j);s.onerror=()=>e(s.error),s.onsuccess=()=>{this.db=s.result,t()},s.onupgradeneeded=a=>{const n=a.target.result;n.objectStoreNames.contains(u.STAGES)||n.createObjectStore(u.STAGES,{keyPath:"id"}).createIndex("order","order",{unique:!1}),n.objectStoreNames.contains(u.TASKS)||n.createObjectStore(u.TASKS,{keyPath:"id"}).createIndex("stageId","stageId",{unique:!1}),n.objectStoreNames.contains(u.HISTORY)||n.createObjectStore(u.HISTORY,{keyPath:"id"}).createIndex("taskId","taskId",{unique:!1}),n.objectStoreNames.contains(u.PROJECTS)||n.createObjectStore(u.PROJECTS,{keyPath:"id"}).createIndex("name","name",{unique:!1})}}),this.initPromise)}getStore(t,e="readonly"){if(!this.db)throw new Error("Database not initialized");return this.db.transaction(t,e).objectStore(t)}async getAllStages(){return await this.init(),new Promise((t,e)=>{const a=this.getStore(u.STAGES).getAll();a.onsuccess=()=>{const n=a.result;t(n.sort((r,c)=>r.order-c.order))},a.onerror=()=>e(a.error)})}async saveStage(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.STAGES,"readwrite").put(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}async deleteStage(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.STAGES,"readwrite").delete(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}async getAllTasks(){return await this.init(),new Promise((t,e)=>{const a=this.getStore(u.TASKS).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>e(a.error)})}async getTaskById(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.TASKS).get(t);n.onsuccess=()=>e(n.result),n.onerror=()=>s(n.error)})}async getTasksByStage(t){return await this.init(),new Promise((e,s)=>{const r=this.getStore(u.TASKS).index("stageId").getAll(t);r.onsuccess=()=>e(r.result),r.onerror=()=>s(r.error)})}async saveTask(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.TASKS,"readwrite").put(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}async deleteTask(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.TASKS,"readwrite").delete(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}async addHistoryEntry(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.HISTORY,"readwrite").add(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}async getHistoryByTask(t){return await this.init(),new Promise((e,s)=>{const r=this.getStore(u.HISTORY).index("taskId").getAll(t);r.onsuccess=()=>{const c=r.result;e(c.sort((i,l)=>new Date(l.timestamp).getTime()-new Date(i.timestamp).getTime()))},r.onerror=()=>s(r.error)})}async clearHistory(){return await this.init(),new Promise((t,e)=>{const a=this.getStore(u.HISTORY,"readwrite").clear();a.onsuccess=()=>t(),a.onerror=()=>e(a.error)})}async getAllProjects(){return await this.init(),new Promise((t,e)=>{const a=this.getStore(u.PROJECTS).getAll();a.onsuccess=()=>{const n=a.result;t(n.sort((r,c)=>new Date(c.updatedAt).getTime()-new Date(r.updatedAt).getTime()))},a.onerror=()=>e(a.error)})}async getProjectById(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.PROJECTS).get(t);n.onsuccess=()=>e(n.result),n.onerror=()=>s(n.error)})}async saveProject(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.PROJECTS,"readwrite").put(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}async deleteProject(t){return await this.init(),new Promise((e,s)=>{const n=this.getStore(u.PROJECTS,"readwrite").delete(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)})}}const d=new P;function I(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function L(p){return p.toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}class C{async getStages(){return d.getAllStages()}async createStage(t,e){const a=(await d.getAllStages()).reduce((r,c)=>Math.max(r,c.order),-1),n={id:I(),name:t,color:e,order:a+1};return await d.saveStage(n),n}async updateStage(t,e,s){const a=await this.getStageById(t);if(!a)throw new Error("–≠—Ç–∞–ø –Ω–µ –Ω–∞–π–¥–µ–Ω");a.name=e,a.color=s,await d.saveStage(a)}async deleteStage(t){const e=await d.getTasksByStage(t);for(const s of e)await this.addHistoryEntry(s.id,"task_deleted",`–ó–∞–¥–∞—á–∞ "${s.title}" —É–¥–∞–ª–µ–Ω–∞ –≤–º–µ—Å—Ç–µ —Å —ç—Ç–∞–ø–æ–º`),await d.deleteTask(s.id);await d.deleteStage(t)}async getStageById(t){return(await d.getAllStages()).find(s=>s.id===t)}async getTasks(){return d.getAllTasks()}async createTask(t,e,s=[]){const a=new Date,n={id:I(),title:e,description:"",stageId:t,cardTypes:s,notes:[],createdAt:a.toISOString(),updatedAt:a.toISOString()};return await d.saveTask(n),await this.addHistoryEntry(n.id,"task_created",`–ó–∞–¥–∞—á–∞ "${e}" —Å–æ–∑–¥–∞–Ω–∞`),n}async updateTask(t,e){const s=await d.getTaskById(t);if(!s)throw new Error("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const a=s.title;if(e.title!==void 0&&(s.title=e.title),e.description!==void 0&&(s.description=e.description),e.stageId!==void 0&&e.stageId!==s.stageId){const n=await this.getStageById(e.stageId);s.stageId=e.stageId,await this.addHistoryEntry(s.id,"task_moved",`–ó–∞–¥–∞—á–∞ "${a}" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ "${(n==null?void 0:n.name)||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç—Ç–∞–ø"}"`)}return e.title!==void 0&&e.title!==a&&await this.addHistoryEntry(s.id,"task_updated",`–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ —Å "${a}" –Ω–∞ "${e.title}"`),s.updatedAt=new Date().toISOString(),await d.saveTask(s),s}async deleteTask(t){const e=await d.getTaskById(t);e&&(await this.addHistoryEntry(t,"task_deleted",`–ó–∞–¥–∞—á–∞ "${e.title}" —É–¥–∞–ª–µ–Ω–∞`),await d.deleteTask(t))}async getTaskById(t){return d.getTaskById(t)}async addNote(t,e,s){const a=await d.getTaskById(t);if(!a)throw new Error("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const n=a.notes.length+1,r={id:I(),title:e||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",content:s,createdAt:new Date().toISOString()};return a.notes.push(r),a.updatedAt=new Date().toISOString(),await d.saveTask(a),await this.addHistoryEntry(t,"note_added",`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ ‚Ññ${n}`),r}async updateNote(t,e,s,a){const n=await d.getTaskById(t);if(!n)throw new Error("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const r=n.notes.find(i=>i.id===e);if(!r)throw new Error("–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const c=n.notes.indexOf(r)+1;r.title=a||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",r.content=s,n.updatedAt=new Date().toISOString(),await d.saveTask(n),await this.addHistoryEntry(t,"note_updated",`–ò–∑–º–µ–Ω–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ ‚Ññ${c}`)}async deleteNote(t,e){const s=await d.getTaskById(t);if(!s)throw new Error("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const a=s.notes.find(r=>r.id===e);if(!a)throw new Error("–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const n=s.notes.indexOf(a)+1;s.notes=s.notes.filter(r=>r.id!==e),s.updatedAt=new Date().toISOString(),await d.saveTask(s),await this.addHistoryEntry(t,"note_deleted",`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ ‚Ññ${n}`)}async addHistoryEntry(t,e,s){const a={id:I(),taskId:t,operationType:e,description:s,timestamp:new Date().toISOString()};await d.addHistoryEntry(a)}async getTaskHistory(t){return d.getHistoryByTask(t)}async clearTaskHistory(t){return await d.init(),new Promise((e,s)=>{const n=d.db.transaction("history","readwrite").objectStore("history"),c=n.index("taskId").getAllKeys(t);c.onsuccess=()=>{const i=c.result;if(i.length===0){e();return}let l=0;for(const g of i){const m=n.delete(g);m.onsuccess=()=>{l++,l>=i.length&&e()},m.onerror=()=>s(m.error)}},c.onerror=()=>s(c.error)})}formatDateTime(t){return L(new Date(t))}async getProjects(){return d.getAllProjects()}async createProject(t,e=""){const s=new Date,a={id:I(),name:t,description:e,taskItems:[],createdAt:s.toISOString(),updatedAt:s.toISOString()};return await d.saveProject(a),a}async updateProject(t,e){const s=await d.getProjectById(t);if(!s)throw new Error("–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");return e.name!==void 0&&(s.name=e.name),e.description!==void 0&&(s.description=e.description),s.updatedAt=new Date().toISOString(),await d.saveProject(s),s}async deleteProject(t){await d.deleteProject(t)}async getProjectById(t){return d.getProjectById(t)}async createTaskItem(t,e,s=""){const a=await d.getProjectById(t);if(!a)throw new Error("–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");const n=new Date,r={id:I(),title:e,description:s,status:"active",boardState:void 0,createdAt:n.toISOString(),updatedAt:n.toISOString()};return a.taskItems.push(r),a.updatedAt=n.toISOString(),await d.saveProject(a),r}async updateTaskItem(t,e,s){const a=await d.getProjectById(t);if(!a)throw new Error("–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");const n=a.taskItems.find(r=>r.id===e);if(!n)throw new Error("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");return s.title!==void 0&&(n.title=s.title),s.description!==void 0&&(n.description=s.description),s.status!==void 0&&(n.status=s.status),s.boardState!==void 0&&(n.boardState=s.boardState),n.updatedAt=new Date().toISOString(),a.updatedAt=n.updatedAt,await d.saveProject(a),n}async deleteTaskItem(t,e){const s=await d.getProjectById(t);if(!s)throw new Error("–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");s.taskItems=s.taskItems.filter(a=>a.id!==e),s.updatedAt=new Date().toISOString(),await d.saveProject(s)}async getTaskItemById(t,e){const s=await d.getProjectById(t);if(s)return s.taskItems.find(a=>a.id===e)}async getActiveTasksCount(t){const e=await d.getProjectById(t);return e?e.taskItems.filter(s=>s.status==="active").length:0}}const h=new C;class B{constructor(t,e,s,a,n){o(this,"onTaskClick");o(this,"onTaskDelete");o(this,"onStageEdit");o(this,"onStageDelete");o(this,"onAddTask");this.onTaskClick=t,this.onTaskDelete=e,this.onStageEdit=s,this.onStageDelete=a,this.onAddTask=n}renderStage(t,e){const s=document.createElement("div");s.className="stage",s.dataset.stageId=t.id;const a=e.filter(i=>i.stageId===t.id);s.innerHTML=`
      <div class="stage-header" style="background: ${t.color}">
        <span class="stage-name">${this.escapeHtml(t.name)} (${a.length})</span>
        <div class="stage-actions">
          <button class="stage-btn edit-stage-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∞–ø">‚úèÔ∏è</button>
          <button class="stage-btn delete-stage-btn" title="–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø">üóëÔ∏è</button>
        </div>
      </div>
      <div class="stage-content">
        ${a.length>0?a.map(i=>this.renderTaskCard(i,t.color)).join(""):'<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>'}
      </div>
      <button class="add-task-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É</button>
    `;const n=s.querySelector(".edit-stage-btn");n==null||n.addEventListener("click",i=>{i.stopPropagation(),this.onStageEdit(t)});const r=s.querySelector(".delete-stage-btn");r==null||r.addEventListener("click",i=>{i.stopPropagation(),confirm(`–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø "${t.name}" –∏ –≤—Å–µ –µ–≥–æ –∑–∞–¥–∞—á–∏?`)&&this.onStageDelete(t)});const c=s.querySelector(".add-task-btn");return c==null||c.addEventListener("click",()=>{this.onAddTask(t.id)}),s.querySelectorAll(".task-card-delete").forEach(i=>{i.addEventListener("click",l=>{l.stopPropagation();const m=l.target.closest(".task-card").dataset.taskId;m&&this.onTaskDelete(m)})}),s.querySelectorAll(".task-card").forEach(i=>{i.addEventListener("click",()=>{const l=i.dataset.taskId;l&&this.onTaskClick(l)})}),this.setupStageDragDrop(s,t.id),s}renderTaskCard(t,e){const s=t.notes.length,a=h.formatDateTime(t.createdAt),n=t.cardTypes.length>0?`<div class="task-card-types">${t.cardTypes.map(r=>`<span class="task-card-type-badge" data-type="${r}">${this.getTypeLabel(r)}</span>`).join("")}</div>`:"";return`
      <div class="task-card" draggable="true" data-task-id="${t.id}" style="--stage-color: ${e}">
        <button class="task-card-delete" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">&times;</button>
        <div class="task-card-title">${this.escapeHtml(t.title)}</div>
        ${n}
        <div class="task-card-meta">
          <span>${a}</span>
          ${s>0?`<span class="task-card-notes">${s}</span>`:""}
        </div>
      </div>
    `}getTypeLabel(t){switch(t){case"feature":return"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞";case"bug":return"–ë–∞–≥";case"enhancement":return"–£–ª—É—á—à–µ–Ω–∏–µ";case"docs":return"–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è";case"refactor":return"–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥";case"test":return"–¢–µ—Å—Ç—ã";case"ci":return"CI/CD";case"security":return"–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å";case"performance":return"–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å";case"design":return"–î–∏–∑–∞–π–Ω";case"translation":return"–ü–µ—Ä–µ–≤–æ–¥";default:return t}}setupStageDragDrop(t,e){const s=t.querySelector(".stage-content");s&&(s.addEventListener("dragover",a=>{const n=a;n.preventDefault();const r=document.querySelector(".task-card.dragging");if(r){t.classList.add("drag-over");const c=this.getDragAfterElement(s,n.clientY);c?s.insertBefore(r,c):s.appendChild(r)}}),s.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),s.addEventListener("drop",a=>{a.preventDefault(),t.classList.remove("drag-over")}))}getDragAfterElement(t,e){return[...t.querySelectorAll(".task-card:not(.dragging)")].reduce((n,r)=>{const c=r.getBoundingClientRect(),i=e-c.top-c.height/2;return i<0&&i>n.offset?{offset:i,element:r}:n},{offset:Number.NEGATIVE_INFINITY,element:null}).element}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}updateTaskCount(t,e){const s=t.querySelector(".stage-name");if(s){const a=this.getStageFromElement(t);a&&(s.textContent=`${a.name} (${e})`)}}getStageFromElement(t){var c;const e=t.dataset.stageId;if(!e)return null;const s=t.querySelector(".stage-header");if(!s)return null;const a=getComputedStyle(s).backgroundColor,n=t.querySelector(".stage-name"),r=((c=n==null?void 0:n.textContent)==null?void 0:c.replace(/ \(\d+\)$/,""))||"";return{id:e,name:r,color:a,order:0}}}class A{constructor(t,e,s,a,n,r,c){o(this,"panel");o(this,"currentTask",null);o(this,"stages",[]);o(this,"onSaveCallback");o(this,"onDeleteCallback");o(this,"onAddNoteCallback");o(this,"onUpdateNoteCallback");o(this,"onDeleteNoteCallback");o(this,"onViewHistoryCallback");o(this,"onCloseCallback");this.panel=document.getElementById("task-panel"),this.onSaveCallback=t,this.onDeleteCallback=e,this.onAddNoteCallback=s,this.onUpdateNoteCallback=a,this.onDeleteNoteCallback=n,this.onViewHistoryCallback=r,this.onCloseCallback=c,this.setupEventListeners()}setStages(t){this.stages=t,this.updateStageSelect()}show(t){this.currentTask=t,this.panel.classList.remove("hidden"),this.populateForm(t),this.updateStageSelect(),this.renderNotes(t.notes)}hide(){this.panel.classList.add("hidden"),this.currentTask=null}populateForm(t){document.getElementById("task-panel-title").textContent="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—á–∏",document.getElementById("task-title").value=t.title,document.getElementById("task-description").value=t.description||""}updateStageSelect(){const t=document.getElementById("task-stage");t.innerHTML=this.stages.map(e=>{var s;return`<option value="${e.id}" ${((s=this.currentTask)==null?void 0:s.stageId)===e.id?"selected":""}>${this.escapeHtml(e.name)}</option>`}).join("")}renderNotes(t){const e=document.getElementById("notes-list");if(t.length===0){e.innerHTML='<div class="empty-state">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';return}e.innerHTML=t.map((s,a)=>`
      <div class="note-item" data-note-id="${s.id}">
        <div class="note-item-header">
          <div class="note-item-title">
            <span class="note-item-number">‚Ññ${a+1}</span>
            <span class="note-item-date">${h.formatDateTime(s.createdAt)}</span>
          </div>
          <div class="note-item-actions">
            <button class="edit-note-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <button class="delete-note-btn" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </div>
        </div>
        <div class="note-item-text" title="${this.escapeHtml(s.content)}">${this.escapeHtml(s.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</div>
      </div>
    `).join(""),e.querySelectorAll(".edit-note-btn").forEach(s=>{s.addEventListener("click",a=>{const r=a.target.closest(".note-item").dataset.noteId;this.openNoteModal(r)})}),e.querySelectorAll(".delete-note-btn").forEach(s=>{s.addEventListener("click",a=>{var i;const r=a.target.closest(".note-item").dataset.noteId,c=(i=this.currentTask)==null?void 0:i.notes.find(l=>l.id===r);c&&confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É "${c.title}"?`)&&this.deleteNote(r)})}),e.querySelectorAll(".note-item-text").forEach(s=>{s.addEventListener("click",()=>{const n=s.closest(".note-item").dataset.noteId;this.openNoteModal(n)})})}openNoteModal(t){if(!this.currentTask)return;const e=this.currentTask.notes.find(m=>m.id===t);if(!e)return;const s=document.getElementById("note-modal"),a=document.getElementById("note-title-input"),n=document.getElementById("note-content-input"),r=document.getElementById("note-modal-title");if(!s||!a||!n||!r)return;a.value=e.title||"",n.value=e.content||"",s.classList.remove("hidden");const c=document.getElementById("save-note-btn"),i=document.getElementById("cancel-note-btn"),l=async()=>{const m=a.value.trim()||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",k=n.value;(k!==e.content||m!==e.title)&&this.currentTask&&(await this.onUpdateNoteCallback(this.currentTask.id,t,k,m),this.currentTask=await h.getTaskById(this.currentTask.id)||null,this.currentTask&&this.renderNotes(this.currentTask.notes)),s.classList.add("hidden"),c==null||c.removeEventListener("click",l),i==null||i.removeEventListener("click",g)},g=()=>{s.classList.add("hidden"),c==null||c.removeEventListener("click",l),i==null||i.removeEventListener("click",g)};c==null||c.addEventListener("click",l),i==null||i.addEventListener("click",g)}async deleteNote(t){this.currentTask&&(await this.onDeleteNoteCallback(this.currentTask.id,t),this.currentTask=await h.getTaskById(this.currentTask.id)||null,this.currentTask&&this.renderNotes(this.currentTask.notes))}setupEventListeners(){document.getElementById("close-panel-btn").addEventListener("click",()=>{this.onCloseCallback()});const t=document.getElementById("task-title"),e=document.getElementById("task-description"),s=document.getElementById("task-stage");let a;const n=()=>{clearTimeout(a),a=setTimeout(()=>this.saveChanges(),500)};t.addEventListener("input",n),e.addEventListener("input",n),s.addEventListener("change",()=>this.saveChanges());const r=document.getElementById("add-note-btn"),c=async()=>{const i=document.getElementById("note-modal"),l=document.getElementById("note-title-input"),g=document.getElementById("note-content-input"),m=document.getElementById("note-modal-title");if(!i||!l||!g||!m)return;m.textContent="–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞",l.value="",g.value="",i.classList.remove("hidden");const k=document.getElementById("save-note-btn"),y=document.getElementById("cancel-note-btn"),f=async()=>{const S=l.value.trim()||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",v=g.value.trim();v&&this.currentTask&&(await this.onAddNoteCallback(this.currentTask.id,S,v),this.currentTask=await h.getTaskById(this.currentTask.id)||null,this.currentTask&&this.renderNotes(this.currentTask.notes)),i.classList.add("hidden"),k==null||k.removeEventListener("click",f),y==null||y.removeEventListener("click",T)},T=()=>{i.classList.add("hidden"),k==null||k.removeEventListener("click",f),y==null||y.removeEventListener("click",T)};k==null||k.addEventListener("click",f),y==null||y.addEventListener("click",T)};r.addEventListener("click",c),document.getElementById("view-history-btn").addEventListener("click",()=>{this.currentTask&&this.onViewHistoryCallback(this.currentTask.id)}),document.getElementById("delete-task-btn").addEventListener("click",async()=>{this.currentTask&&confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${this.currentTask.title}"?`)&&(await this.onDeleteCallback(this.currentTask.id),this.hide())})}async saveChanges(){if(!this.currentTask)return;const t=document.getElementById("task-title"),e=document.getElementById("task-description"),s=document.getElementById("task-stage"),a={};t.value!==this.currentTask.title&&(a.title=t.value.trim()),e.value!==this.currentTask.description&&(a.description=e.value),s.value!==this.currentTask.stageId&&(a.stageId=s.value),Object.keys(a).length>0&&(await this.onSaveCallback(this.currentTask.id,a),this.currentTask=await h.getTaskById(this.currentTask.id)||null)}refreshCurrentTask(){this.currentTask&&h.getTaskById(this.currentTask.id).then(t=>{t&&(this.currentTask=t,this.populateForm(t),this.renderNotes(t.notes))})}getCurrentTask(){return this.currentTask}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}class D{constructor(t){o(this,"panel",null);o(this,"historyList",null);o(this,"currentTaskId",null);o(this,"onClearCallback",null);o(this,"refreshTimeout",null);o(this,"eventListenersInitialized",!1);this.onClearCallback=t||null}ensureInitialized(){if(!this.eventListenersInitialized){if(this.panel=document.getElementById("history-panel"),this.historyList=document.getElementById("history-list"),!this.panel||!this.historyList){console.error("History panel elements not found");return}this.setupEventListeners(),this.eventListenersInitialized=!0}}show(t,e){this.ensureInitialized(),this.currentTaskId=e,this.panel&&this.panel.classList.remove("hidden"),this.renderHistory(t)}hide(){this.panel&&this.panel.classList.add("hidden"),this.currentTaskId=null}async refresh(t){this.refreshTimeout&&clearTimeout(this.refreshTimeout);const e=t||this.currentTaskId;e&&(this.refreshTimeout=setTimeout(async()=>{try{const s=await h.getTaskHistory(e);this.renderHistory(s)}catch(s){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:",s)}this.refreshTimeout=null},100))}async refreshImmediate(t){this.ensureInitialized();const e=t||this.currentTaskId;if(e)try{const s=await h.getTaskHistory(e);this.renderHistory(s)}catch(s){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:",s)}}renderHistory(t){if(this.historyList){if(t.length===0){this.historyList.innerHTML='<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';return}this.historyList.innerHTML=t.map((e,s)=>{const a=this.boldQuotedText(e.description),n=h.formatDateTime(e.timestamp);return`
        <div class="history-item">
          <div class="history-item-number">${s+1}</div>
          <div class="history-item-content">
            <div class="history-item-description">${a}</div>
          </div>
          <div class="history-item-time">${n}</div>
        </div>
      `}).join("")}}boldQuotedText(t){let e=t.replace(/"([^"]+)"/g,'<strong>"$1"</strong>');return e=e.replace(/‚Ññ(\d+)/g,"<strong>‚Ññ$1</strong>"),e.split(/(<strong>.*?<\/strong>)/g).map(a=>a.startsWith("<strong>")?a:this.escapeHtml(a)).join("")}setupEventListeners(){if(!this.panel)return;const t=this.panel.querySelector("#close-history-btn"),e=this.panel.querySelector("#clear-history-btn");t==null||t.addEventListener("click",()=>{this.hide()}),e==null||e.addEventListener("click",async()=>{if(this.currentTaskId&&this.onClearCallback&&confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏?"))try{await this.onClearCallback(this.currentTaskId),await this.refreshImmediate()}catch(s){console.error("Error clearing history:",s)}})}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}class M{constructor(t,e,s,a,n){o(this,"container");o(this,"onProjectClick");o(this,"onProjectEdit");o(this,"onProjectDelete");o(this,"onAddProject");this.container=t,this.onProjectClick=e,this.onProjectEdit=s,this.onProjectDelete=a,this.onAddProject=n}async render(){const t=await h.getProjects();if(t.length===0){this.container.innerHTML=`
        <div class="empty-state projects-empty">
          <p>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
          <button class="btn btn-primary" id="add-first-project-btn">+ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
        </div>
      `;const e=this.container.querySelector("#add-first-project-btn");e==null||e.addEventListener("click",()=>this.onAddProject())}else this.container.innerHTML=`
        <div class="projects-table-container">
          <table class="projects-table">
            <thead>
              <tr>
                <th class="col-name">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th class="col-description">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th class="col-stat">–í —Ä–∞–±–æ—Ç–µ</th>
                <th class="col-stat">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</th>
                <th class="col-stat">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ</th>
                <th class="col-stat">–í—Å–µ–≥–æ</th>
                <th class="col-date">–û–±–Ω–æ–≤–ª—ë–Ω</th>
                <th class="col-actions"></th>
              </tr>
            </thead>
            <tbody>
              ${t.map(e=>this.renderProjectRow(e)).join("")}
            </tbody>
          </table>
        </div>
      `,this.container.querySelectorAll(".project-row").forEach(e=>{const s=e.dataset.projectId;s&&e.addEventListener("click",a=>{a.target.closest(".project-actions")||this.onProjectClick(s)})}),this.container.querySelectorAll(".edit-project-btn").forEach(e=>{e.addEventListener("click",s=>{s.stopPropagation();const a=s.target.closest(".project-row"),n=a==null?void 0:a.dataset.projectId;if(n){const r=t.find(c=>c.id===n);r&&this.onProjectEdit(r)}})}),this.container.querySelectorAll(".delete-project-btn").forEach(e=>{e.addEventListener("click",s=>{s.stopPropagation();const a=s.target.closest(".project-row"),n=a==null?void 0:a.dataset.projectId;if(n){const r=t.find(c=>c.id===n);r&&confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${r.name}" –∏ –≤—Å–µ –µ–≥–æ –∑–∞–¥–∞—á–∏?`)&&this.onProjectDelete(r)}})})}renderProjectRow(t){const e=t.taskItems.filter(r=>r.status==="active").length,s=t.taskItems.length,a=t.taskItems.filter(r=>r.status==="completed").length,n=t.taskItems.filter(r=>r.status==="revision").length;return`
      <tr class="project-row" data-project-id="${t.id}">
        <td class="project-name">${this.escapeHtml(t.name)}</td>
        <td class="project-description">${this.escapeHtml(t.description)||"‚Äî"}</td>
        <td class="project-stat stat-active">${e}</td>
        <td class="project-stat stat-completed">${a}</td>
        <td class="project-stat stat-revision">${n}</td>
        <td class="project-stat stat-total">${s}</td>
        <td class="project-date">${h.formatDateTime(t.updatedAt)}</td>
        <td class="project-actions">
          <button class="project-action-btn edit-project-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç">‚úèÔ∏è</button>
          <button class="project-action-btn delete-project-btn" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç">üóëÔ∏è</button>
        </td>
      </tr>
    `}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}class H{constructor(t,e,s,a,n,r){o(this,"container");o(this,"currentProject",null);o(this,"onTaskClick");o(this,"onTaskEdit");o(this,"onTaskDelete");o(this,"onAddTask");o(this,"onBack");this.container=t,this.onTaskClick=e,this.onTaskEdit=s,this.onTaskDelete=a,this.onAddTask=n,this.onBack=r}async render(t){const e=await h.getProjectById(t);if(!e){this.container.innerHTML='<div class="empty-state">–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';return}this.currentProject=e;const s=e.taskItems.filter(i=>i.status==="active"),a=e.taskItems.filter(i=>i.status==="completed"),n=e.taskItems.filter(i=>i.status==="revision");this.container.innerHTML=`
      <div class="task-list-header">
        <button class="btn btn-icon back-btn" id="back-to-projects-btn">‚Üê</button>
        <div class="task-list-title-block">
          <h1 class="task-list-title">${this.escapeHtml(e.name)}</h1>
          ${e.description?`<p class="task-list-description">${this.escapeHtml(e.description)}</p>`:""}
        </div>
        <button class="btn btn-primary" id="add-task-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>

      <div class="tasks-table-container">
        <table class="tasks-table">
          <thead>
            <tr>
              <th class="col-name">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th class="col-description">–û–ø–∏—Å–∞–Ω–∏–µ</th>
              <th class="col-status">–°—Ç–∞—Ç—É—Å</th>
              <th class="col-date">–°–æ–∑–¥–∞–Ω–∞</th>
              <th class="col-actions"></th>
            </tr>
          </thead>
          <tbody>
            ${s.length>0?s.map(i=>this.renderTaskRow(i,"active")).join(""):""}
            ${n.length>0?n.map(i=>this.renderTaskRow(i,"revision")).join(""):""}
            ${a.length>0?a.map(i=>this.renderTaskRow(i,"completed")).join(""):""}
          </tbody>
        </table>
      </div>
    `;const r=this.container.querySelector("#back-to-projects-btn");r==null||r.addEventListener("click",()=>this.onBack());const c=this.container.querySelector("#add-task-btn");c==null||c.addEventListener("click",()=>this.onAddTask()),this.container.querySelectorAll(".task-row").forEach(i=>{const l=i.dataset.taskId;l&&i.addEventListener("click",g=>{g.target.closest(".task-actions")||this.onTaskClick(l)})}),this.container.querySelectorAll(".edit-task-item-btn").forEach(i=>{i.addEventListener("click",l=>{l.stopPropagation();const g=l.target.closest(".task-row"),m=g==null?void 0:g.dataset.taskId;if(m&&this.currentProject){const k=this.currentProject.taskItems.find(y=>y.id===m);k&&this.onTaskEdit(k)}})}),this.container.querySelectorAll(".delete-task-item-btn").forEach(i=>{i.addEventListener("click",l=>{l.stopPropagation();const g=l.target.closest(".task-row"),m=g==null?void 0:g.dataset.taskId;if(m&&this.currentProject){const k=this.currentProject.taskItems.find(y=>y.id===m);k&&confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${k.title}"?`)&&this.onTaskDelete(k)}})})}renderTaskRow(t,e){const s=this.getStatusLabel(e);return`
      <tr class="task-row" data-task-id="${t.id}">
        <td class="task-name">${this.escapeHtml(t.title)}</td>
        <td class="task-description">${this.escapeHtml(t.description)||"‚Äî"}</td>
        <td class="task-status">${s}</td>
        <td class="task-date">${h.formatDateTime(t.createdAt)}</td>
        <td class="task-actions">
          <button class="task-action-btn edit-task-item-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É">‚úèÔ∏è</button>
          <button class="task-action-btn delete-task-item-btn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">üóëÔ∏è</button>
        </td>
      </tr>
    `}getStatusLabel(t){switch(t){case"active":return"–ñ–¥—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è";case"completed":return"–ó–∞–≤–µ—Ä—à–µ–Ω–æ";case"revision":return"–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ";default:return t}}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}async refresh(){this.currentProject&&await this.render(this.currentProject.id)}}class ${constructor(){o(this,"projectsView");o(this,"taskListView");o(this,"boardView");o(this,"appTitle");o(this,"addProjectBtn");o(this,"projectsListContainer");o(this,"taskListContainer");o(this,"board");o(this,"boardTaskTitle");o(this,"projectList");o(this,"taskList");o(this,"stageRenderer");o(this,"taskPanel");o(this,"historyPanel");o(this,"currentProjectId",null);o(this,"currentTaskItemId",null);o(this,"currentTaskId",null);o(this,"isMovingTask",!1);o(this,"stageModal");o(this,"projectModal");o(this,"taskItemModal");o(this,"cardModal");o(this,"editingStageId",null);o(this,"editingProjectId",null);o(this,"editingTaskItemId",null);o(this,"selectedCardTypes",[]);o(this,"currentStageIdForCard",null);o(this,"stages",[]);o(this,"tasks",[]);this.projectsView=document.getElementById("projects-view"),this.taskListView=document.getElementById("task-list-view"),this.boardView=document.getElementById("board-view"),this.appTitle=document.getElementById("app-title"),this.addProjectBtn=document.getElementById("add-project-btn"),this.projectsListContainer=document.getElementById("projects-list"),this.taskListContainer=document.getElementById("task-list-container"),this.board=document.getElementById("board"),this.boardTaskTitle=document.getElementById("board-task-title"),this.stageModal=document.getElementById("stage-modal"),this.projectModal=document.getElementById("project-modal"),this.taskItemModal=document.getElementById("task-item-modal"),this.cardModal=document.getElementById("card-modal"),this.projectList=new M(this.projectsListContainer,t=>this.openProject(t),t=>this.openProjectModal(t),t=>this.deleteProject(t),()=>this.openProjectModal()),this.taskList=new H(this.taskListContainer,t=>this.openTaskItem(t),t=>this.openTaskItemModal(t),t=>this.deleteTaskItem(t),()=>this.openTaskItemModal(),()=>this.showProjects()),this.stageRenderer=new B(t=>this.openTask(t),t=>this.deleteTask(t),t=>this.editStage(t),t=>this.deleteStage(t),t=>this.addTask(t)),this.taskPanel=new A((t,e)=>this.updateTask(t,e),t=>this.deleteTask(t),(t,e,s)=>this.addNote(t,e,s),(t,e,s,a)=>this.updateNote(t,e,s,a),(t,e)=>this.deleteNote(t,e),t=>this.showHistory(t),()=>this.closeTaskPanel()),this.historyPanel=new D(t=>this.clearHistory(t)),this.setupEventListeners(),this.showProjects()}setupEventListeners(){document.getElementById("save-project-btn").addEventListener("click",()=>{this.saveProject()}),document.getElementById("cancel-project-btn").addEventListener("click",()=>{this.closeProjectModal()}),this.projectModal.addEventListener("click",t=>{t.target===this.projectModal&&this.closeProjectModal()}),document.getElementById("save-task-item-btn").addEventListener("click",()=>{this.saveTaskItem()}),document.getElementById("cancel-task-item-btn").addEventListener("click",()=>{this.closeTaskItemModal()}),this.taskItemModal.addEventListener("click",t=>{t.target===this.taskItemModal&&this.closeTaskItemModal()}),document.getElementById("save-card-btn").addEventListener("click",()=>{this.saveCard()}),document.getElementById("cancel-card-btn").addEventListener("click",()=>{this.closeCardModal()}),this.cardModal.addEventListener("click",t=>{t.target===this.cardModal&&this.closeCardModal()}),document.querySelectorAll(".card-type-tile").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-type");this.toggleCardType(e)})}),document.getElementById("back-to-tasks-btn").addEventListener("click",()=>{this.currentProjectId&&this.showTaskList(this.currentProjectId)}),document.getElementById("add-stage-btn").addEventListener("click",()=>{this.openStageModal()}),document.getElementById("save-stage-btn").addEventListener("click",()=>{this.saveStage()}),document.getElementById("cancel-stage-btn").addEventListener("click",()=>{this.closeStageModal()}),this.stageModal.addEventListener("click",t=>{t.target===this.stageModal&&this.closeStageModal()})}showView(t){this.projectsView.classList.toggle("hidden",t!=="projects"),this.taskListView.classList.toggle("hidden",t!=="taskList"),this.boardView.classList.toggle("hidden",t!=="board"),t==="projects"?(this.appTitle.textContent="–ü—Ä–æ–µ–∫—Ç—ã",this.addProjectBtn.textContent="+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç",this.addProjectBtn.classList.remove("hidden")):t==="taskList"?(this.appTitle.textContent="–ó–∞–¥–∞—á–∏",this.addProjectBtn.classList.add("hidden")):(this.appTitle.textContent="–ü–æ–¥–∑–∞–¥–∞—á–∏",this.addProjectBtn.classList.add("hidden")),this.addProjectBtn.onclick=()=>{t==="projects"?this.openProjectModal():t==="taskList"&&this.openTaskItemModal()}}async showProjects(){this.currentProjectId=null,this.currentTaskItemId=null,this.currentTaskId=null,(await h.getProjects()).length===0&&await this.createDefaultProject(),this.showView("projects"),await this.projectList.render()}async createDefaultProject(){try{const t=await h.createProject("–ü—Ä–æ–µ–∫—Ç1","–ü—Ä–æ–µ–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");await h.createTaskItem(t.id,"–ó–∞–¥–∞—á–∞1","–ó–∞–¥–∞—á–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"),console.log("–°–æ–∑–¥–∞–Ω –ø—Ä–æ–µ–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –∑–∞–¥–∞—á–µ–π")}catch(t){console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:",t)}}async showTaskList(t){this.currentProjectId=t,this.currentTaskItemId=null,this.currentTaskId=null,this.showView("taskList"),await this.taskList.render(t)}async showBoard(t){this.currentProjectId&&(this.currentTaskItemId=t,this.showView("board"),await this.loadBoard(t))}openProjectModal(t){this.editingProjectId=(t==null?void 0:t.id)||null;const e=document.getElementById("project-modal-title"),s=document.getElementById("project-name"),a=document.getElementById("project-description");t?(e.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç",s.value=t.name,a.value=t.description):(e.textContent="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç",s.value="",a.value=""),this.projectModal.classList.remove("hidden"),s.focus()}closeProjectModal(){this.projectModal.classList.add("hidden"),this.editingProjectId=null}async saveProject(){const t=document.getElementById("project-name"),e=document.getElementById("project-description"),s=t.value.trim(),a=e.value.trim();if(!s){alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞");return}try{this.editingProjectId?await h.updateProject(this.editingProjectId,{name:s,description:a}):await h.createProject(s,a),this.closeProjectModal(),await this.projectList.render()}catch(n){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:",n),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞")}}async deleteProject(t){try{await h.deleteProject(t.id),await this.projectList.render()}catch(e){console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞")}}async openProject(t){await this.showTaskList(t)}openTaskItemModal(t){this.editingTaskItemId=(t==null?void 0:t.id)||null;const e=document.getElementById("task-item-modal-title"),s=document.getElementById("task-item-title"),a=document.getElementById("task-item-description"),n=document.getElementById("task-item-status");t?(e.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É",s.value=t.title,a.value=t.description,n.value=t.status):(e.textContent="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞",s.value="",a.value="",n.value="active"),this.taskItemModal.classList.remove("hidden"),s.focus()}closeTaskItemModal(){this.taskItemModal.classList.add("hidden"),this.editingTaskItemId=null}async saveTaskItem(){if(!this.currentProjectId)return;const t=document.getElementById("task-item-title"),e=document.getElementById("task-item-description"),s=document.getElementById("task-item-status"),a=t.value.trim(),n=e.value.trim(),r=s.value;if(!a){alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏");return}try{this.editingTaskItemId?await h.updateTaskItem(this.currentProjectId,this.editingTaskItemId,{title:a,description:n,status:r}):await h.createTaskItem(this.currentProjectId,a,n),this.closeTaskItemModal(),await this.taskList.render(this.currentProjectId)}catch(c){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:",c),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏")}}async deleteTaskItem(t){if(this.currentProjectId)try{await h.deleteTaskItem(this.currentProjectId,t.id),await this.taskList.render(this.currentProjectId)}catch(e){console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏")}}async openTaskItem(t){await this.showBoard(t)}async loadBoard(t){if(!this.currentProjectId)return;const e=await h.getTaskItemById(this.currentProjectId,t);if(!e){alert("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"),this.showTaskList(this.currentProjectId);return}if(this.boardTaskTitle.textContent=e.title,!e.boardState||!e.boardState.stages||e.boardState.stages.length===0){await this.createDefaultBoardState(t);const s=await h.getTaskItemById(this.currentProjectId,t);if(!s||!s.boardState){alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å–∫–∏"),this.showTaskList(this.currentProjectId);return}this.stages=s.boardState.stages,this.tasks=s.boardState.tasks}else{const s=e.boardState;this.stages=s.stages,this.tasks=s.tasks}this.renderBoard(),this.taskPanel.setStages(this.stages)}async createDefaultBoardState(t){if(!this.currentProjectId)return;const e=[{name:"–ù—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å",color:"#e09f7d"},{name:"–í —Ä–∞–±–æ—Ç–µ",color:"#f4c77e"},{name:"–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",color:"#b8a5e0"},{name:"–ì–æ—Ç–æ–≤–æ",color:"#9bc9a3"}],s=[];for(let n=0;n<e.length;n++){const r={id:`stage-${n}-${Date.now()}`,name:e[n].name,color:e[n].color,order:n};s.push(r)}const a={stages:s,tasks:[],history:[]};await h.updateTaskItem(this.currentProjectId,t,{boardState:a})}renderBoard(){this.board.innerHTML="";for(const t of this.stages){const e=this.stageRenderer.renderStage(t,this.tasks);this.board.appendChild(e)}this.setupTaskDragDrop()}async saveBoardState(){if(!this.currentProjectId||!this.currentTaskItemId)return;const t={stages:this.stages,tasks:this.tasks,history:[]};await h.updateTaskItem(this.currentProjectId,this.currentTaskItemId,{boardState:t})}openStageModal(t){this.editingStageId=(t==null?void 0:t.id)||null;const e=document.getElementById("stage-modal-title"),s=document.getElementById("stage-name"),a=document.getElementById("stage-color");t?(e.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∞–ø",s.value=t.name,a.value=this.rgbToHex(t.color)):(e.textContent="–ù–æ–≤—ã–π —ç—Ç–∞–ø",s.value="",a.value="#4a90d9"),this.stageModal.classList.remove("hidden"),s.focus()}closeStageModal(){this.stageModal.classList.add("hidden"),this.editingStageId=null}async saveStage(){const t=document.getElementById("stage-name"),e=document.getElementById("stage-color"),s=t.value.trim(),a=e.value;if(!s){alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞");return}try{if(this.editingStageId){const n=this.stages.find(r=>r.id===this.editingStageId);n&&(n.name=s,n.color=a,await this.saveBoardState())}else{const n={id:`stage-${Date.now()}`,name:s,color:a,order:this.stages.length};this.stages.push(n),await this.saveBoardState()}this.closeStageModal(),this.renderBoard()}catch(n){console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞:",n),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —ç—Ç–∞–ø–∞")}}async editStage(t){this.openStageModal(t)}async deleteStage(t){try{const e=this.tasks.filter(s=>s.stageId===t.id);for(const s of e)await this.deleteTask(s.id);this.stages=this.stages.filter(s=>s.id!==t.id),this.stages.forEach((s,a)=>s.order=a),await this.saveBoardState(),this.renderBoard()}catch(e){console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç—Ç–∞–ø–∞")}}async addTask(t){this.currentStageIdForCard=t,this.selectedCardTypes=[],this.updateCardTypesSelection();const e=document.getElementById("card-title");e.value="",document.getElementById("card-modal-title").textContent="–ù–æ–≤–∞—è –ø–æ–¥–∑–∞–¥–∞—á–∞",this.cardModal.classList.remove("hidden"),e.focus()}updateCardTypesSelection(){document.querySelectorAll(".card-type-tile").forEach(e=>{const s=e.getAttribute("data-type");this.selectedCardTypes.includes(s)?e.classList.add("selected"):e.classList.remove("selected")})}toggleCardType(t){const e=this.selectedCardTypes.indexOf(t);e>-1?this.selectedCardTypes.splice(e,1):this.selectedCardTypes.push(t),this.updateCardTypesSelection()}closeCardModal(){this.cardModal.classList.add("hidden"),this.currentStageIdForCard=null,this.selectedCardTypes=[]}async saveCard(){if(!this.currentStageIdForCard)return;const e=document.getElementById("card-title").value.trim();if(!e){alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏");return}try{const s=await this.createTaskInBoard(this.currentStageIdForCard,e.trim(),this.selectedCardTypes);this.tasks.push(s),this.renderBoard(),await this.saveBoardState(),this.closeCardModal()}catch(s){console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:",s),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏")}}async createTaskInBoard(t,e,s=[]){const a=new Date;return{id:`task-${Date.now()}`,title:e,description:"",stageId:t,cardTypes:s,notes:[],createdAt:a.toISOString(),updatedAt:a.toISOString()}}openTask(t){const e=this.tasks.find(s=>s.id===t);e&&(this.currentTaskId=t,this.taskPanel.show(e),this.historyPanel.refreshImmediate(t))}closeTaskPanel(){this.taskPanel.hide(),this.currentTaskId=null}async updateTask(t,e){try{const s=this.tasks.findIndex(r=>r.id===t);if(s===-1)return;const a=this.tasks[s],n=a.title;if(e.title!==void 0&&(a.title=e.title),e.description!==void 0&&(a.description=e.description),e.stageId!==void 0&&e.stageId!==a.stageId){const r=this.stages.find(c=>c.id===e.stageId);a.stageId=e.stageId,this.addHistoryEntry(t,"task_moved",`–ó–∞–¥–∞—á–∞ "${n}" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ "${(r==null?void 0:r.name)||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç—Ç–∞–ø"}"`)}a.updatedAt=new Date().toISOString(),this.tasks[s]=a,this.renderBoard(),await this.saveBoardState(),this.currentTaskId===t&&(this.taskPanel.refreshCurrentTask(),this.historyPanel.refreshImmediate(t))}catch(s){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:",s)}}async deleteTask(t){try{const e=this.tasks.find(s=>s.id===t);e&&this.addHistoryEntry(t,"task_deleted",`–ó–∞–¥–∞—á–∞ "${e.title}" —É–¥–∞–ª–µ–Ω–∞`),this.tasks=this.tasks.filter(s=>s.id!==t),this.renderBoard(),this.closeTaskPanel(),await this.saveBoardState()}catch(e){console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏")}}async addNote(t,e,s){try{const a=this.tasks.find(c=>c.id===t);if(!a)return;const n=a.notes.length+1,r={id:`note-${Date.now()}`,title:e||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",content:s,createdAt:new Date().toISOString()};a.notes.push(r),a.updatedAt=new Date().toISOString(),this.addHistoryEntry(t,"note_added",`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ ‚Ññ${n}`),await this.saveBoardState(),this.currentTaskId===t&&(this.taskPanel.show(a),this.historyPanel.refreshImmediate(t))}catch(a){console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:",a)}}async updateNote(t,e,s,a){try{const n=this.tasks.find(i=>i.id===t);if(!n)return;const r=n.notes.find(i=>i.id===e);if(!r)return;const c=n.notes.indexOf(r)+1;r.title=a||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",r.content=s,n.updatedAt=new Date().toISOString(),this.addHistoryEntry(t,"note_updated",`–ò–∑–º–µ–Ω–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ ‚Ññ${c}`),await this.saveBoardState(),this.currentTaskId===t&&this.historyPanel.refreshImmediate(t)}catch(n){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:",n)}}async deleteNote(t,e){try{const s=this.tasks.find(r=>r.id===t);if(!s)return;const a=s.notes.find(r=>r.id===e);if(!a)return;const n=s.notes.indexOf(a)+1;s.notes=s.notes.filter(r=>r.id!==e),s.updatedAt=new Date().toISOString(),this.addHistoryEntry(t,"note_deleted",`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ ‚Ññ${n}`),await this.saveBoardState(),this.currentTaskId===t&&this.historyPanel.refreshImmediate(t)}catch(s){console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:",s)}}addHistoryEntry(t,e,s){console.log(`History: ${e} - ${s}`)}async showHistory(t){const e=[];this.historyPanel.show(e,t)}async clearHistory(t){}setupTaskDragDrop(){document.querySelectorAll(".task-card").forEach(e=>{e.addEventListener("dragstart",s=>{var r;const a=s;e.classList.add("dragging");const n=e;(r=a.dataTransfer)==null||r.setData("text/plain",n.dataset.taskId||""),a.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),document.querySelectorAll(".stage").forEach(s=>{s.classList.remove("drag-over")})})}),this.board.addEventListener("dragover",e=>{e.preventDefault()}),this.board.addEventListener("drop",async e=>{var r;e.preventDefault();const a=(r=e.dataTransfer)==null?void 0:r.getData("text/plain"),n=e.target.closest(".stage");if(a&&n){const c=n.dataset.stageId;c&&await this.moveTask(a,c)}})}async moveTask(t,e){if(!this.isMovingTask){this.isMovingTask=!0;try{await this.updateTask(t,{stageId:e})}catch(s){console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:",s)}finally{this.isMovingTask=!1}}}rgbToHex(t){if(t.startsWith("#"))return t;const e=t.match(/\d+/g);if(!e)return"#4a90d9";const[s,a,n]=e.map(Number);return"#"+[s,a,n].map(r=>r.toString(16).padStart(2,"0")).join("")}}document.addEventListener("DOMContentLoaded",()=>{new $});
